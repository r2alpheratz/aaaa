<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="LogMgn">

	<select id="selectLogInfoList" parameterType="hashmap" resultType="logInfoVo">
		SELECT T2.*
		FROM (
			SELECT ROW_NUMBER() OVER(ORDER BY "eventDt" DESC, LOG_SQ DESC) AS NUM,
				   T1.*
			FROM (
			SELECT SYSLOG.LOG_SQ,
				   SYSLOG.EVENT_IP,
				   SYSLOG.USER_ID,
				   TO_CHAR(SYSLOG.EVENT_DT, 'yyyy/MM/dd hh:MI:ss') "eventDt",
				   SYSLOG.EVENT_CD,
				   CODEINFO.CODE_NM "eventNm",
				   SYSLOG.LOG_MSG
			FROM TB_FR_SYS_LOG SYSLOG,
			     TB_FR_CODE_INFO CODEINFO
			WHERE 1=1 AND SYSLOG.EVENT_CD = CODEINFO.CODE_SQ
			<if test="srchUserId != null and srchUserId != ''">
				AND UPPER(SYSLOG.USER_ID) LIKE '%'||UPPER(#{srchUserId})||'%'
			</if>
			<if test="fromEventDt != null and fromEventDt != ''">
				<![CDATA[
					AND TO_CHAR(SYSLOG.EVENT_DT, 'yyyy/MM/dd hh:MI:ss') >= CONCAT(#{fromEventDt}, ' 00:00:00')
				]]>
			</if>
			<if test="toEventDt != null and toEventDt != ''">
				<![CDATA[
					AND TO_CHAR(SYSLOG.EVENT_DT, 'yyyy/MM/dd hh:MI:ss') <= CONCAT(#{toEventDt}, ' 23:59:59')
				]]>
			</if>
			<if test="workScCd.equalsIgnoreCase('A')">
				AND SYSLOG.EVENT_CD IN ('LOG_000011', 'LOG_000012', 'LOG_000013')
			</if>
			<if test="workScCd.equalsIgnoreCase('W')">
				AND SYSLOG.EVENT_CD IN (SELECT CODE_SQ FROM TB_FR_CODE_INFO WHERE PARENT_CODE_SQ = 'LOG_000002' AND USE_YN = 'Y')
			</if>
			<if test="srchEventCd != null and srchEventCd != ''">
				AND UPPER(SYSLOG.EVENT_CD) LIKE CONCAT('%', UPPER(#{srchEventCd}), '%')
			</if>
		<![CDATA[
		) T1) T2
    	WHERE NUM <= #{readcount} + #{readindex} AND NUM > #{readindex}
		]]>
	</select>

	<select id="selectLogInfoListCount" resultType="int">
        SELECT  COUNT(*)
		  FROM TB_FR_SYS_LOG
		 WHERE 1=1
		 <if test="srchUserId != null and srchUserId != ''">
			AND UPPER(USER_ID) LIKE '%'||UPPER(#{srchUserId})||'%'
		</if>
		<if test="fromEventDt != null and fromEventDt != ''">
			<![CDATA[
				AND TO_CHAR(EVENT_DT, 'yyyy/MM/dd hh:MI:ss') >= CONCAT(#{fromEventDt}, ' 00:00:00')
			]]>
		</if>
		<if test="toEventDt != null and toEventDt != ''">
			<![CDATA[
				AND TO_CHAR(EVENT_DT, 'yyyy/MM/dd hh:MI:ss') <= CONCAT(#{toEventDt}, ' 23:59:59')
			]]>
		</if>
		<if test="workScCd.equalsIgnoreCase('A')">
			AND EVENT_CD IN ('LOG_000011', 'LOG_000012', 'LOG_000013')
		</if>
		<if test="workScCd.equalsIgnoreCase('W')">
			AND EVENT_CD IN (SELECT CODE_SQ FROM TB_FR_CODE_INFO WHERE PARENT_CODE_SQ = 'LOG_000002' AND USE_YN = 'Y')
		</if>
		<if test="srchEventCd != null and srchEventCd != ''">
			AND UPPER(EVENT_CD) LIKE CONCAT('%', UPPER(#{srchEventCd}), '%')
		</if>
	</select>	

	<insert id="insertLogInfo" parameterType="logInfoVo">
		INSERT INTO TB_FR_SYS_LOG
		( LOG_SQ, EVENT_IP, USER_ID, EVENT_DT, EVENT_CD, LOG_MSG)
		VALUES (#{logSq}, #{eventIp}, #{userId}, NOW() , #{eventCd}, #{logMsg})
	</insert>

	<select id="getTodayLogCnt" parameterType="string" resultType="int">
		SELECT COUNT(*)
		FROM TB_FR_SYS_LOG
		WHERE SUBSTR(LOG_SQ, 1, 9) = #{seqHeader}
	</select>
	
	<select id="getRecentLoginUserByIp" parameterType="hashmap" resultType="string">
		SELECT T1.USER_ID
		FROM(
			SELECT USER_ID, ROW_NUMBER() OVER(ORDER BY USER_ID) AS NUM
			FROM TB_FR_SYS_LOG
			WHERE EVENT_IP = #{ipAddress} AND EVENT_CD = #{loginCode}
			ORDER BY EVENT_DT DESC
		) T1
		WHERE NUM = 1
	</select>
	<select id="getEventCd" parameterType="hashmap" resultType="string">
		SELECT TEMP.USER_ID
		FROM(
			SELECT (ROW_NUMBER() OVER()) AS ROWNUM, USER_ID
			FROM TB_FR_CODE_INFO
			WHERE CODE_NM = #{codeNm} 
			  AND PARENT_CODE_SQ = #{parentCodeSq}
			LIMIT 1
		) TEMP
	</select>
	
	<select id="getTodayImpersonLogCnt" parameterType="string" resultType="int">
		SELECT COUNT(*)
		FROM TB_FR_SYS_IMPERSON_LOG
		WHERE SUBSTR(LOG_SQ, 1, 9) = #{seqHeader}
	</select>
	<insert id="insertImpersonLogInfo" parameterType="logInfoVo">
		INSERT INTO TB_FR_SYS_IMPERSON_LOG
		( LOG_SQ, EVENT_IP, REAL_USER_ID, USER_ID, EVENT_DT, EVENT_CD, LOG_MSG)
		VALUES (#{logSq}, #{eventIp}, #{realUserId}, #{userId}, NOW(), #{eventCd}, #{logMsg})
	</insert>
	
	<select id="selectWorkLogInfoList" parameterType="hashmap" resultType="logInfoVo">
		SELECT T2.*
		FROM (
			SELECT ROW_NUMBER() OVER(ORDER BY "eventDt" DESC, LOG_SQ DESC) AS NUM,
				   T1.*
			FROM (
			SELECT SYSLOG.LOG_SQ,
				   SYSLOG.EVENT_IP,
				   SYSLOG.USER_ID,
				   TO_CHAR(SYSLOG.EVENT_DT, 'yyyy/MM/dd hh:MI:ss') "eventDt",
				   SYSLOG.EVENT_CD,
				   <if test="language != null and language !='' ">
		    	   MENUINFO.MESSAGE_VALUE "eventNm",
		      </if>
		 	  <if test="language == null or language =='' ">
	               MENUINFO.MENU_NM "eventNm",
		      </if>
				   SYSLOG.LOG_MSG
			FROM TB_FR_SYS_LOG SYSLOG,
			  <if test="language != null and language !='' ">
		    	   TB_FR_MENU_MULTI_LANG_INFO MENUINFO
		      </if>
		 	  <if test="language == null or language =='' ">
	               TB_FR_MENU_INFO MENUINFO
		      </if>
			WHERE 1=1 AND SYSLOG.EVENT_CD = MENUINFO.MENU_SQ
				AND EVENT_CD NOT IN ('LOG_000011', 'LOG_000012', 'LOG_000013')
			<if test="srchUserId != null and srchUserId != ''">
				AND UPPER(SYSLOG.USER_ID) LIKE '%'||UPPER(#{srchUserId})||'%'
			</if>
			<if test="fromEventDt != null and fromEventDt != ''">
				<![CDATA[
					AND TO_CHAR(SYSLOG.EVENT_DT, 'yyyy/MM/dd hh:MI:ss') >= CONCAT(#{fromEventDt}, ' 00:00:00')
				]]>
			</if>
			<if test="toEventDt != null and toEventDt != ''">
				<![CDATA[
					AND TO_CHAR(SYSLOG.EVENT_DT, 'yyyy/MM/dd hh:MI:ss') <= CONCAT(#{toEventDt}, ' 23:59:59')
				]]>
			</if>
			<if test="srchEventCd != null and srchEventCd != ''">
				AND UPPER(SYSLOG.EVENT_CD) LIKE CONCAT('%', UPPER(#{srchEventCd}), '%')
			</if>
		<![CDATA[
		) T1) T2
    	WHERE NUM <= #{readcount} + #{readindex} AND NUM > #{readindex}
		]]>
	</select>
	
	<select id="selectWorkLogInfoListCount" resultType="int">
        SELECT  COUNT(*)
		  FROM TB_FR_SYS_LOG
		 WHERE 1=1
		 	AND EVENT_CD NOT IN ('LOG_000011', 'LOG_000012', 'LOG_000013')
		 <if test="srchUserId != null and srchUserId != ''">
			AND UPPER(USER_ID) LIKE '%'||UPPER(#{srchUserId})||'%'
		</if>
		<if test="fromEventDt != null and fromEventDt != ''">
			<![CDATA[
				AND TO_CHAR(EVENT_DT, 'yyyy/MM/dd hh:MI:ss') >= CONCAT(#{fromEventDt}, ' 00:00:00')
			]]>
		</if>
		<if test="toEventDt != null and toEventDt != ''">
			<![CDATA[
				AND TO_CHAR(EVENT_DT, 'yyyy/MM/dd hh:MI:ss') <= CONCAT(#{toEventDt}, ' 23:59:59')
			]]>
		</if>
		<if test="srchEventCd != null and srchEventCd != ''">
			AND UPPER(EVENT_CD) LIKE CONCAT('%', UPPER(#{srchEventCd}), '%')
		</if>
	</select>	
</mapper>
